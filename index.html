<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å‹™æ’èª²è¼”åŠ©ç³»çµ± v5.0 (114-2)</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        body {
            background-color: #f0f2f5;
            font-family: 'Noto Sans TC', sans-serif;
        }

        /* --- å…±ç”¨æ¨£å¼ --- */
        .card {
            border-radius: 12px;
            overflow: hidden;
        }

        .checkbox-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            background-color: #fff !important;
        }

        /* è‡ªå®šç¾©æ²è»¸æ¨£å¼ */
        .checkbox-container::-webkit-scrollbar {
            width: 8px;
        }
        .checkbox-container::-webkit-scrollbar-thumb {
            background-color: #adb5bd;
            border-radius: 4px;
        }

        .form-check-input {
            cursor: pointer;
        }
        .form-check-input:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        .grade-title {
            font-size: 0.9rem;
            color: #6c757d;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 8px;
            padding-bottom: 4px;
        }

        /* --- ç³»çµ± Aï¼šä»£èª²æŸ¥è©¢æ¨£å¼ --- */
        .teacher-card {
            transition: transform 0.2s;
            background-color: #fff;
            border-radius: 8px;
            border-left: 4px solid #0dcaf0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: default;
        }
        .teacher-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* --- ç³»çµ± Bï¼šèª¿èª²æŸ¥è©¢æ¨£å¼ --- */
        .bg-purple { background-color: #6f42c1 !important; }
        .text-purple { color: #6f42c1 !important; }
        .border-purple { border-color: #6f42c1 !important; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-purple {
            background-color: #ffffff !important;
            border: 2px solid #6f42c1 !important;
            color: #000000 !important;
            font-weight: bold;
            letter-spacing: 1px;
            transition: all 0.3s;
        }
        .btn-purple:hover {
            background-color: #f3e5f5 !important;
            border-color: #6f42c1 !important;
            color: #000000 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(111, 66, 193, 0.2) !important;
        }
        .btn-purple:disabled {
            background-color: #e9ecef !important;
            border-color: #dee2e6 !important;
            color: #6c757d !important;
            cursor: not-allowed;
            transform: none;
            box-shadow: none !important;
        }

        /* èª²è¡¨è¡¨æ ¼å„ªåŒ– */
        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .timetable {
            width: 100%;
            table-layout: fixed;
            border-collapse: separate;
            border-spacing: 0;
            text-align: center;
            background-color: white;
            min-width: 600px;
        }

        .timetable th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f8f9fa;
            color: #495057;
            font-weight: bold;
            border: 1px solid #dee2e6;
            padding: 8px;
            box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
        }

        .timetable td {
            border: 1px solid #dee2e6;
            padding: 4px;
            font-size: 0.9rem;
            vertical-align: middle;
            height: 60px;
        }

        /* --- èª¿èª²ç‹€æ…‹è‰² --- */
        .cell-target {
            background-color: #0d6efd !important;
            color: white !important;
            box-shadow: inset 0 0 0 2px #0a58ca;
        }

        .cell-self-busy {
            background-color: #e9ecef !important;
            color: #adb5bd !important;
        }
        .cell-self-busy .cell-subject, 
        .cell-self-busy .cell-teacher {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .cell-swap-ok {
            background-color: #d1e7dd !important;
            color: #0f5132 !important;
            border: 2px solid #198754 !important;
            cursor: pointer;
            position: relative;
        }
        .cell-swap-ok::after {
            content: "âœ…å¯èª¿";
            display: block;
            font-size: 0.75em;
            font-weight: bold;
            color: #198754;
            margin-top: 2px;
        }
        
        /* v5.0 æ–°å¢ï¼šæ·ºæ©˜è‰² (ä¸å»ºè­°èª¿èª²) */
        .cell-swap-discouraged {
            background-color: #fff3cd !important;
            color: #856404 !important;
            border: 2px solid #ffecb5 !important;
            cursor: pointer;
            position: relative;
        }
        .cell-swap-discouraged::after {
            content: "âš ï¸ä¸å®œ";
            display: block;
            font-size: 0.75em;
            font-weight: bold;
            color: #d39e00;
            margin-top: 2px;
        }

        .cell-swap-no {
            background-color: #f8d7da !important;
            color: #842029 !important;
            opacity: 0.8;
        }
        .cell-swap-no::after {
            content: "âŒæ’å ‚";
            display: block;
            font-size: 0.75em;
            color: #842029;
        }

        .cell-subject {
            font-weight: bold;
            display: block;
            font-size: 0.95em;
            line-height: 1.2;
        }
        .cell-teacher {
            font-size: 0.85em;
            opacity: 0.9;
            display: block;
        }
    </style>
</head>
<body>

<div class="container py-5">
  
  <!-- æ¨™é¡Œå€ -->
  <div class="text-center mb-4">
    <h1 class="fw-bold text-primary">ğŸ« æ ¡å‹™æ’èª²è¼”åŠ©ç³»çµ± <span class="badge bg-danger fs-5 align-middle ms-2">114-2 é›²ç«¯ç‰ˆ</span></h1>
    <p class="text-muted">æœ¬ç³»çµ±å·²æ›´æ–°è‡³ 114å­¸å¹´åº¦ç¬¬2å­¸æœŸ å®Œæ•´èª²è¡¨è³‡æ–™</p>
  </div>

  <!-- ========================================== -->
  <!-- â˜ï¸ é›²ç«¯è³‡æ–™ç‹€æ…‹å€ -->
  <!-- ========================================== -->
  <div class="card shadow-sm mb-5 border-0">
    <div class="card-header bg-dark text-white fw-bold d-flex justify-content-between align-items-center">
      <span><i class="bi bi-cloud-arrow-down-fill me-2"></i>é›²ç«¯è³‡æ–™åº«é€£ç·šç‹€æ…‹</span>
      <button onclick="fetchDataFromCloud()" class="btn btn-sm btn-outline-light">é‡æ–°é€£ç·š</button>
    </div>
    <div class="card-body bg-light">
      <div class="row text-center" id="loadingStatusArea">
        <div class="col-12 py-3">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2 text-primary fw-bold">æ­£åœ¨å¾é›²ç«¯ä¸‹è¼‰æœ€æ–°èª²è¡¨ï¼Œè«‹ç¨å€™...</p>
        </div>
      </div>
      
      <div class="row g-3 d-none" id="dataStatusArea">
        <div class="col-md-4">
          <div class="p-2 border rounded bg-white text-success border-success text-center">
            <i class="bi bi-person-badge-fill me-1"></i> æ•™å¸«èª²è¡¨ï¼š<span id="statusTeacher" class="fw-bold badge bg-success">è¼‰å…¥ä¸­</span>
          </div>
        </div>
        <div class="col-md-4">
          <div class="p-2 border rounded bg-white text-success border-success text-center">
            <i class="bi bi-list-task me-1"></i> ä»»èª²åå–®ï¼š<span id="statusMapping" class="fw-bold badge bg-success">è¼‰å…¥ä¸­</span>
          </div>
        </div>
        <div class="col-md-4">
          <div class="p-2 border rounded bg-white text-success border-success text-center">
            <i class="bi bi-calendar3 me-1"></i> ç­ç´šèª²è¡¨ï¼š<span id="statusClass" class="fw-bold badge bg-success">è¼‰å…¥ä¸­</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========================================== -->
  <!-- ğŸ” ç³»çµ± Aï¼šä»£èª²æŸ¥è©¢ç³»çµ± (è—è‰²ç³») -->
  <!-- ========================================== -->
  <div class="card shadow mb-5 border-0">
    <div class="card-header bg-primary text-white fw-bold py-3 d-flex justify-content-between align-items-center">
      <span><i class="bi bi-search me-2"></i>ä»£èª²è€å¸«æŸ¥è©¢ç³»çµ±</span>
      <span class="badge bg-light text-primary">æ‰¾ä»£èª²</span>
    </div>
    <div class="card-body">
      
      <!-- A1. æ™‚é–“é¸æ“‡ -->
      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <label class="form-label fw-bold">ç¼ºèª²æ˜ŸæœŸ</label>
          <select id="daySelect" class="form-select bg-light border-primary">
            <option value="1">æ˜ŸæœŸä¸€</option>
            <option value="2">æ˜ŸæœŸäºŒ</option>
            <option value="3">æ˜ŸæœŸä¸‰</option>
            <option value="4">æ˜ŸæœŸå››</option>
            <option value="5">æ˜ŸæœŸäº”</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-bold">ç¼ºèª²ç¯€æ¬¡</label>
          <select id="periodSelect" class="form-select bg-light border-primary">
            <option value="1">ç¬¬ä¸€ç¯€</option>
            <option value="2">ç¬¬äºŒç¯€</option>
            <option value="3">ç¬¬ä¸‰ç¯€</option>
            <option value="4">ç¬¬å››ç¯€</option>
            <option value="5">ç¬¬äº”ç¯€</option>
            <option value="6">ç¬¬å…­ç¯€</option>
            <option value="7">ç¬¬ä¸ƒç¯€</option>
            <option value="8">ç¬¬å…«ç¯€</option>
          </select>
        </div>
      </div>

      <!-- A2. ç§‘ç›®ç¯©é¸ -->
      <div class="mb-3">
        <label class="form-label fw-bold text-success"><i class="bi bi-check-square me-1"></i>ç¯©é¸ç§‘ç›® (å¯è¤‡é¸)</label>
        <div id="subjectCheckboxArea" class="d-flex flex-wrap gap-2 p-3 bg-light rounded border checkbox-container">
          <span class="text-muted small">è³‡æ–™è¼‰å…¥ä¸­...</span>
        </div>
      </div>

      <!-- A3. ç­ç´šç¯©é¸ -->
      <div class="mb-4">
        <label class="form-label fw-bold text-secondary"><i class="bi bi-people-fill me-1"></i>ç¯©é¸ç­ç´šä»»èª²è€å¸« (å¯è¤‡é¸)</label>
        <div class="row g-2 p-3 bg-light rounded border checkbox-container" id="classCheckboxArea">
           <span class="text-muted small p-2">è³‡æ–™è¼‰å…¥ä¸­...</span>
        </div>
      </div>
      
      <button id="searchBtn" class="btn btn-primary w-100 btn-lg shadow" disabled>
        è³‡æ–™è¼‰å…¥ä¸­...
      </button>

      <div id="resultArea" class="mt-4"></div>
    </div>
  </div>

  <hr class="my-5 border-3 border-dark opacity-25">

  <!-- ========================================== -->
  <!-- ğŸ”„ ç³»çµ± Bï¼šèª¿èª²æŸ¥è©¢ç³»çµ± (ç´«è‰²ç³») -->
  <!-- ========================================== -->
  <div class="card shadow mb-5 border-0">
    <div class="card-header bg-purple text-white fw-bold py-3 d-flex justify-content-between align-items-center">
      <span><i class="bi bi-arrow-left-right me-2"></i>èª¿èª²æŸ¥è©¢ç³»çµ±</span>
      <span class="badge bg-light text-purple">æ’èª¿èª²</span>
    </div>
    <div class="card-body bg-light">
      
      <div class="row g-3 align-items-end">
        <!-- é¸æ“‡è€å¸« (Input + Datalist) -->
        <div class="col-md-5">
          <label for="rescheduleTeacherInput" class="form-label fw-bold text-purple">1. é¸æ“‡æ‚¨çš„å§“å (å¯è¼¸å…¥å¿«æœ)</label>
          <input class="form-control form-control-lg border-purple" list="teacherOptions" id="rescheduleTeacherInput" placeholder="é»æ“Šé¸æ“‡æˆ–è¼¸å…¥å§“å...">
          <datalist id="teacherOptions">
            <!-- JS è‡ªå‹•ç”Ÿæˆ -->
          </datalist>
        </div>

        <!-- é¸æ“‡è«‹å‡æ˜ŸæœŸ -->
        <div class="col-md-5">
          <label class="form-label fw-bold text-purple">2. é¸æ“‡è«‹å‡æ˜ŸæœŸ</label>
          <select id="rescheduleDaySelect" class="form-select form-select-lg border-purple">
            <option value="1">æ˜ŸæœŸä¸€</option>
            <option value="2">æ˜ŸæœŸäºŒ</option>
            <option value="3">æ˜ŸæœŸä¸‰</option>
            <option value="4">æ˜ŸæœŸå››</option>
            <option value="5">æ˜ŸæœŸäº”</option>
          </select>
        </div>

        <!-- æŸ¥è©¢æŒ‰éˆ• -->
        <div class="col-md-2">
          <button id="rescheduleBtn" class="btn btn-purple w-100 btn-lg shadow" disabled>
            æŸ¥è©¢
          </button>
        </div>
      </div>

      <!-- ç‹€æ…‹èªªæ˜ -->
      <div class="alert alert-white border border-purple mt-4 small text-muted shadow-sm">
        <div class="d-flex align-items-center flex-wrap gap-3">
          <strong><i class="bi bi-info-circle-fill text-purple me-1"></i> ç‹€æ…‹èªªæ˜ï¼š</strong>
          <span><span class="badge bg-primary">è—è‰²</span> æœ¬å ‚è«‹å‡</span>
          <span><span class="badge bg-secondary">ç°è‰²</span> ä¸å¯èª¿ (æœ¬äººæœ‰èª²)</span>
          <span><span class="badge bg-success border border-success">æ·ºç¶ </span> å¯èª¿èª² âœ… (å°æ–¹ç©ºå ‚)</span>
          <span><span class="badge bg-warning text-dark border border-warning">æ·ºæ©˜</span> ä¸å®œèª¿ âš ï¸ (å…¼èª²/æŠ½é›¢/æœ¬åœŸèª/è‹±è³‡)</span>
          <span><span class="badge bg-danger bg-opacity-75">æ·ºç´…</span> æ’å ‚ âŒ (å°æ–¹æœ‰èª²)</span>
        </div>
        <div class="mt-2 text-muted small border-top pt-2">
          <i class="bi bi-exclamation-triangle-fill text-warning me-1"></i> 
          <strong>æ·ºæ©˜è‰²èªªæ˜ï¼š</strong>å…¼èª²è€å¸«ã€æœ¬åœŸèªã€è‹±èªèª²ã€å­¸ç¿’ä¸­å¿ƒçš„èª²ç¨‹ï¼ˆè‹±è³‡/æŠ½é›¢ï¼‰çš†ä¸å»ºè­°èª¿èª²ã€‚è‹¥æœ‰å¿…è¦ï¼Œè«‹å…ˆé›»æ´½æ•™å‹™è™•æ•™å­¸çµ„æˆ–æ˜¯å­¸ç¿’ä¸­å¿ƒè©¢å•èª¿èª²çš„å¯èƒ½æ€§ã€‚
        </div>
      </div>

      <hr class="my-4">

      <!-- èª¿èª²çµæœé¡¯ç¤ºå€ -->
      <div id="rescheduleResultArea">
        <div class="text-center text-muted py-4">
          <h5>è«‹é¸æ“‡å§“åèˆ‡æ™‚é–“ï¼Œç³»çµ±å°‡åˆ—å‡ºå—å½±éŸ¿ç­ç´šçš„å®Œæ•´èª²è¡¨...</h5>
        </div>
      </div>

    </div>
  </div>

  <div class="text-center text-muted small pb-5">
    &copy; 114-2 æ ¡å‹™æ’èª²è¼”åŠ©ç³»çµ± (Smart Search v5.0)
  </div>

</div>

<!-- JavaScript Logic -->
<script>
// ==========================================
// 1. é›²ç«¯æª”æ¡ˆè¨­å®š (GitHub Gist 114-2)
// ==========================================
const CLOUD_URLS = {
  teachers: 'https://gist.githubusercontent.com/leomiboy/3d1d6547a9b935f252ce21510d1e33e4/raw/teachers.json',
  mapping: 'https://gist.githubusercontent.com/leomiboy/3d1d6547a9b935f252ce21510d1e33e4/raw/mapping.json',
  schedules: 'https://gist.githubusercontent.com/leomiboy/3d1d6547a9b935f252ce21510d1e33e4/raw/schedules.json'
};

// ==========================================
// 2. ç‰¹æ®Šèª²ç¨‹è¦å‰‡è¨­å®š (v5.0 æ–°å¢)
// ==========================================

// A. å…¼èª²è€å¸«åå–® (éœ€æ¨™ç¤ºæ·ºæ©˜)
const PART_TIME_TEACHERS = [
  "é™³æ·‘å¨Ÿ", "é å‹æ¢…", "å¼µå“²éŠ˜", "æ—æ˜­å®‰", "ç‹æ„·éœ‡", "è¨±é­æ¢…è¯", "æ›¾å®‡æ‰¿", "å³æ·‘è", "é‚Šå®‡æƒ "
];

// B. å­¸ç¿’ä¸­å¿ƒ/æŠ½é›¢èª²ç¨‹è¦å‰‡ (ç­ç´š ID -> éœ€æ¨™ç¤ºç‚ºæ·ºæ©˜çš„ç§‘ç›®é—œéµå­—)
const RESOURCE_ROOM_RULES = {};

// è¼”åŠ©å‡½å¼ï¼šæ‰¹æ¬¡è¨­å®šè¦å‰‡
function setResourceRule(classes, subjects) {
  classes.forEach(cls => {
    if (!RESOURCE_ROOM_RULES[cls]) RESOURCE_ROOM_RULES[cls] = [];
    RESOURCE_ROOM_RULES[cls].push(...subjects);
  });
}

// ä¹å¹´ç´šç¾¤çµ„
setResourceRule(["901"], ["è‹±èª", "è‹±èªDNA"]);
setResourceRule(["903", "904", "905"], ["åœ‹æ–‡", "è®€å¯«è¬è¯åœ’", "æƒ³äº«DNA", "è‹±èª", "è‹±èªDNA", "æ•¸å­¸"]);
setResourceRule(["907", "908", "910", "911"], ["æƒ³äº«DNA"]);

// å…«å¹´ç´šç¾¤çµ„
setResourceRule(["805", "806", "807"], ["åœ‹æ–‡", "æƒ³äº«DNA", "è‹±èª", "è‹±èªDNA", "æ•¸å­¸"]);

// ä¸ƒå¹´ç´šç¾¤çµ„
setResourceRule(["706", "707", "708", "709", "710"], ["åœ‹æ–‡", "æƒ³äº«DNA", "è‹±èª", "è‹±èªDNA", "æ•¸å­¸"]);
setResourceRule(["701", "702", "703", "704", "705", "711"], ["æƒ³äº«DNA"]);


// ==========================================
// 3. å…¨åŸŸè®Šæ•¸
// ==========================================
let teachersData = [];
let classTeacherMapping = {};
let classSchedules = {};

// DOM å…ƒç´ 
const loadingStatusArea = document.getElementById('loadingStatusArea');
const dataStatusArea = document.getElementById('dataStatusArea');
const searchBtn = document.getElementById('searchBtn');
const rescheduleBtn = document.getElementById('rescheduleBtn');

// ç³»çµ± A å…ƒç´ 
const daySelect = document.getElementById('daySelect');
const periodSelect = document.getElementById('periodSelect');
const resultArea = document.getElementById('resultArea');

// ç³»çµ± B å…ƒç´ 
const rescheduleTeacherInput = document.getElementById('rescheduleTeacherInput');
const teacherOptions = document.getElementById('teacherOptions');
const rescheduleDaySelect = document.getElementById('rescheduleDaySelect');
const rescheduleResultArea = document.getElementById('rescheduleResultArea');


// ==========================================
// 4. è‡ªå‹•å¾é›²ç«¯æŠ“å–è³‡æ–™ (Fetch Data)
// ==========================================
async function fetchDataFromCloud() {
  if(loadingStatusArea) loadingStatusArea.classList.remove('d-none');
  if(dataStatusArea) dataStatusArea.classList.add('d-none');
  
  if(searchBtn) { searchBtn.disabled = true; searchBtn.textContent = "è³‡æ–™è¼‰å…¥ä¸­..."; }
  if(rescheduleBtn) { rescheduleBtn.disabled = true; rescheduleBtn.textContent = "è³‡æ–™è¼‰å…¥ä¸­..."; }

  try {
    console.log("é–‹å§‹å¾ GitHub Gist ä¸‹è¼‰è³‡æ–™...");
    
    // åŠ ä¸€å€‹ Timestamp é˜²æ­¢ Cache
    const ts = new Date().getTime();
    const [teachersRes, mappingRes, schedulesRes] = await Promise.all([
      fetch(`${CLOUD_URLS.teachers}?t=${ts}`),
      fetch(`${CLOUD_URLS.mapping}?t=${ts}`),
      fetch(`${CLOUD_URLS.schedules}?t=${ts}`)
    ]);

    if (!teachersRes.ok || !mappingRes.ok || !schedulesRes.ok) {
      throw new Error("ç¶²è·¯é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ GitHub Gist é€£çµæ˜¯å¦æ­£ç¢ºã€‚");
    }

    const rawTeachers = await teachersRes.json();
    const rawMapping = await mappingRes.json();
    const rawSchedules = await schedulesRes.json();

    // --- A. è§£ææ•™å¸«èª²è¡¨ ---
    if (Array.isArray(rawTeachers)) {
      teachersData = rawTeachers;
    } else {
      throw new Error("æ•™å¸«èª²è¡¨ JSON æ ¼å¼éŒ¯èª¤");
    }

    // --- B. è§£æä»»èª²åå–® ---
    const processedMap = {};
    if (rawMapping.classes && Array.isArray(rawMapping.classes)) {
      rawMapping.classes.forEach(cls => {
        if (cls.class_id) {
          let allTeachers = [];
          if (cls.teachers && Array.isArray(cls.teachers)) {
            allTeachers = [...cls.teachers];
          }
          if (cls.homeroom_teacher) {
            allTeachers.unshift(cls.homeroom_teacher);
          }
          processedMap[cls.class_id] = [...new Set(allTeachers)];
        }
      });
      classTeacherMapping = processedMap;
    } else {
       if(typeof rawMapping === 'object') classTeacherMapping = rawMapping;
    }

    // --- C. è§£æç­ç´šèª²è¡¨ ---
    let processedSchedules = {};
    const dayMap = { "Monday": "1", "Tuesday": "2", "Wednesday": "3", "Thursday": "4", "Friday": "5" };
    
    if (Array.isArray(rawSchedules)) {
      rawSchedules.forEach(cls => {
        const classID = cls.class_id;
        if (!classID || !cls.schedule) return;
        processedSchedules[classID] = {};
        
        for (const [dayName, periods] of Object.entries(cls.schedule)) {
          const dayCode = dayMap[dayName];
          if (dayCode && Array.isArray(periods)) {
            periods.forEach(p => {
              if (p.period) {
                const key = `${dayCode}-${p.period}`;
                processedSchedules[classID][key] = {
                  subject: p.subject || "",
                  teacher: p.teacher || "ç„¡"
                };
              }
            });
          }
        }
      });
      classSchedules = processedSchedules;
    } else {
      throw new Error("ç­ç´šèª²è¡¨ JSON æ ¼å¼éŒ¯èª¤");
    }

    // --- è¼‰å…¥æˆåŠŸï¼Œæ›´æ–°ä»‹é¢ ---
    if(loadingStatusArea) loadingStatusArea.classList.add('d-none');
    if(dataStatusArea) dataStatusArea.classList.remove('d-none');
    
    if(searchBtn) { searchBtn.disabled = false; searchBtn.textContent = "æŸ¥è©¢ç¬¦åˆæ¢ä»¶çš„ä»£èª²è€å¸«"; }
    if(rescheduleBtn) { rescheduleBtn.disabled = false; rescheduleBtn.textContent = "æŸ¥è©¢"; }

    initSubjectCheckboxes();
    initClassCheckboxes();
    updateRescheduleTeacherOptions();

    const statusTeacher = document.getElementById('statusTeacher');
    const statusMapping = document.getElementById('statusMapping');
    const statusClass = document.getElementById('statusClass');
    
    if(statusTeacher) statusTeacher.textContent = `å·²è¼‰å…¥ ${teachersData.length} ä½`;
    if(statusMapping) statusMapping.textContent = `å·²è¼‰å…¥ ${Object.keys(classTeacherMapping).length} ç­`;
    if(statusClass) statusClass.textContent = `å·²è¼‰å…¥ ${Object.keys(classSchedules).length} ç­`;

  } catch (error) {
    console.error(error);
    if(loadingStatusArea) {
      loadingStatusArea.innerHTML = `
        <div class="col-12 py-3">
          <div class="alert alert-danger">
            <strong>âŒ è³‡æ–™è¼‰å…¥å¤±æ•—</strong><br>
            è«‹ç¢ºèª GitHub Gist é€£çµæ˜¯å¦æ­£ç¢ºã€‚<br>
            <small class="text-muted">${error.message}</small><br>
            <button onclick="fetchDataFromCloud()" class="btn btn-sm btn-outline-danger mt-2">é‡è©¦</button>
          </div>
        </div>
      `;
    }
  }
}

// ==========================================
// 5. ä»‹é¢åˆå§‹åŒ–èˆ‡å·¥å…·å‡½å¼
// ==========================================

// è¼”åŠ©å‡½å¼ï¼šæ¨™æº–åŒ–å§“å (å»é™¤é–‹é ­æ•¸å­—èˆ‡ç©ºç™½)
function cleanName(name) {
    if (!name) return "";
    return name.replace(/^[\d\s]+/, '');
}

function initSubjectCheckboxes() {
  const container = document.getElementById('subjectCheckboxArea');
  if(!container) return;
  
  container.innerHTML = '';
  const allSubjects = [...new Set(teachersData.map(t => t.subject))].sort();

  allSubjects.forEach((subject, index) => {
    const wrapper = document.createElement('div');
    wrapper.className = 'form-check form-check-inline';
    wrapper.innerHTML = `
      <input class="form-check-input subject-checkbox" type="checkbox" id="subj_${index}" value="${subject}">
      <label class="form-check-label" for="subj_${index}">${subject}</label>
    `;
    container.appendChild(wrapper);
  });
}

function initClassCheckboxes() {
  const container = document.getElementById('classCheckboxArea');
  if(!container) return;
  
  container.innerHTML = '';
  const allClasses = Object.keys(classTeacherMapping).sort();

  const groupedClasses = {};
  allClasses.forEach(cls => {
    const grade = cls.charAt(0);
    if (!groupedClasses[grade]) groupedClasses[grade] = [];
    groupedClasses[grade].push(cls);
  });

  Object.keys(groupedClasses).sort().forEach(grade => {
    const col = document.createElement('div');
    col.className = 'col-12 col-md-4 mb-2';
    
    let html = `<div class="card h-100 border-0 shadow-sm"><div class="card-body p-2">`;
    html += `<div class="grade-title fw-bold">${grade} å¹´ç´š</div><div class="d-flex flex-wrap gap-2">`;
    
    groupedClasses[grade].forEach(cls => {
      html += `
        <div class="form-check">
          <input class="form-check-input class-checkbox" type="checkbox" id="cls_${cls}" value="${cls}">
          <label class="form-check-label small" for="cls_${cls}">${cls}</label>
        </div>
      `;
    });
    
    html += `</div></div></div>`;
    col.innerHTML = html;
    container.appendChild(col);
  });
}

function updateRescheduleTeacherOptions() {
  const teacherNames = teachersData.map(t => t.name).sort((a, b) => a.localeCompare(b, "zh-Hant"));
  
  if(!teacherOptions) return;
  teacherOptions.innerHTML = '';
  
  const uniqueNames = new Set();
  
  teacherNames.forEach(originalName => {
    const displayName = cleanName(originalName);
    if(displayName && !uniqueNames.has(displayName)) {
        uniqueNames.add(displayName);
        const option = document.createElement('option');
        option.value = displayName;
        teacherOptions.appendChild(option);
    }
  });
}

// ==========================================
// 6. ç³»çµ± A é‚è¼¯ï¼šä»£èª²æŸ¥è©¢
// ==========================================

if(searchBtn) {
  searchBtn.addEventListener('click', function() {
    const selectedDay = daySelect.value;
    const selectedPeriod = periodSelect.value;
    const queryKey = `${selectedDay}-${selectedPeriod}`;

    const checkedSubjects = Array.from(document.querySelectorAll('.subject-checkbox:checked')).map(cb => cb.value);
    const checkedClasses = Array.from(document.querySelectorAll('.class-checkbox:checked')).map(cb => cb.value);

    // ç¯©é¸é‚è¼¯
    const availableTeachers = teachersData.filter(teacher => {
      // 1. æ™‚é–“æœ‰ç©º
      if (teacher.busySlots.includes(queryKey)) return false;

      // 2. ç§‘ç›®ç¬¦åˆ (è‹¥æœ‰å‹¾é¸)
      if (checkedSubjects.length > 0 && !checkedSubjects.includes(teacher.subject)) return false;

      // 3. ç­ç´šä»»èª²ç¬¦åˆ (è‹¥æœ‰å‹¾é¸)
      if (checkedClasses.length > 0) {
        const targetTeacherNames = new Set();
        checkedClasses.forEach(cls => {
          const teachersInClass = classTeacherMapping[cls] || [];
          teachersInClass.forEach(name => targetTeacherNames.add(cleanName(name)));
        });
        
        const currentNameClean = cleanName(teacher.name);
        if (!targetTeacherNames.has(currentNameClean)) return false;
      }
      return true;
    });

    renderSystemAResults(availableTeachers, selectedDay, selectedPeriod);
  });
}

function renderSystemAResults(teachers, day, period) {
  if(!resultArea) return;
  resultArea.innerHTML = "";

  if (teachers.length === 0) {
    resultArea.innerHTML = `<div class="alert alert-warning text-center shadow-sm py-4"><h5>ğŸ“­ è©²æ™‚æ®µæ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç©ºå ‚è€å¸«ï¼</h5><p class="mb-0 text-muted">è«‹å˜—è©¦æ¸›å°‘ç¯©é¸æ¢ä»¶ã€‚</p></div>`;
    return;
  }

  const groupedTeachers = {};
  teachers.forEach(teacher => {
    if (!groupedTeachers[teacher.subject]) groupedTeachers[teacher.subject] = [];
    groupedTeachers[teacher.subject].push(teacher);
  });

  let html = `<div class="alert alert-info shadow-sm mb-4 border-start border-5 border-info">
                <h5 class="mb-0">ğŸ“… æ˜ŸæœŸ${day} ç¬¬${period}ç¯€ <span class="badge bg-primary ms-2 rounded-pill">å…± ${teachers.length} äººå¾…å‘½</span></h5>
              </div>`;

  Object.keys(groupedTeachers).sort().forEach(subject => {
    const group = groupedTeachers[subject];
    html += `<div class="card mb-3 border-0 shadow-sm"><div class="card-header bg-white border-bottom-0 pb-0 pt-3"><h5 class="text-secondary border-start border-4 border-info ps-2 fw-bold">${subject} <span class="badge bg-secondary rounded-pill ms-1" style="font-size:0.7em">${group.length}</span></h5></div><div class="card-body pt-2 pb-3"><div class="row g-2">`;
    
    group.forEach(teacher => {
      const displayName = cleanName(teacher.name);
      html += `<div class="col-6 col-md-3 col-lg-2"><div class="p-2 border rounded text-center bg-white teacher-card h-100 d-flex align-items-center justify-content-center"><span class="fw-bold text-dark">${displayName}</span></div></div>`;
    });
    
    html += `</div></div></div>`;
  });
  
  resultArea.innerHTML = html;
}

// ==========================================
// 7. ç³»çµ± B é‚è¼¯ï¼šèª¿èª²æŸ¥è©¢
// ==========================================

// åˆ¤æ–·æŸè€å¸«åœ¨ç‰¹å®šæ™‚æ®µæ˜¯å¦å¿™ç¢Œ
function isTeacherBusy(lookupNameClean, timeKey) {
  if (!lookupNameClean) return false;
  const teacherObj = teachersData.find(t => cleanName(t.name) === lookupNameClean);
  if (!teacherObj) return false; 
  return teacherObj.busySlots.includes(timeKey);
}

/**
 * æª¢æŸ¥æ˜¯å¦ç‚ºã€Œä¸å»ºè­°èª¿èª²ã€çš„èª²ç¨‹ (æ·ºæ©˜è‰²åˆ¤å®š)
 * @param {string} classCode ç­ç´šä»£è™Ÿ (ex: "701")
 * @param {string} subject ç§‘ç›®åç¨±
 * @param {string} teacherName è€å¸«å§“å
 */
function isDiscouragedCourse(classCode, subject, teacherName) {
  if (!subject) return false;
  const cleanTeachName = cleanName(teacherName);

  // 1. å…¼èª²è€å¸« check
  if (PART_TIME_TEACHERS.some(pt => cleanTeachName.includes(pt))) return true;

  // 2. æœ¬åœŸèªè¨€ check
  if (subject.includes("æœ¬åœŸ") || subject.includes("é–©") || subject.includes("å®¢èª")) return true;

  // 3. è‹±èªèª² check (æ’é™¤ è‹±èªDNA)
  // è¦å‰‡ï¼šæ‰€æœ‰è‹±èªèª²çš†æ©˜ï¼Œä½†è‹±èªDNAä¸ç”¨(é™¤éåœ¨å­¸ç¿’ä¸­å¿ƒåå–®)
  if (subject.includes("è‹±èª") && !subject.includes("è‹±èªDNA")) return true;

  // 4. å­¸ç¿’ä¸­å¿ƒ/æŠ½é›¢ç¾¤çµ„ check
  if (RESOURCE_ROOM_RULES[classCode]) {
    // æª¢æŸ¥è©²ç­ç´šçš„è¦å‰‡åˆ—è¡¨ä¸­ï¼Œæ˜¯å¦æœ‰ä»»ä½•ä¸€å€‹é—œéµå­—å‡ºç¾åœ¨ç§‘ç›®åç¨±ä¸­
    const isHit = RESOURCE_ROOM_RULES[classCode].some(ruleKeyword => subject.includes(ruleKeyword));
    if (isHit) return true;
  }

  return false;
}


if(rescheduleBtn) {
  rescheduleBtn.addEventListener('click', function() {
    const targetTeacherInputName = rescheduleTeacherInput.value.trim();
    const targetDay = rescheduleDaySelect.value;

    if (!targetTeacherInputName) {
      alert("è«‹è¼¸å…¥æˆ–é¸æ“‡è€å¸«å§“åï¼"); 
      rescheduleTeacherInput.focus();
      return;
    }
    
    const targetTeacherClean = cleanName(targetTeacherInputName);
    
    // é©—è­‰è€å¸«æ˜¯å¦å­˜åœ¨
    const teacherExists = teachersData.some(t => cleanName(t.name) === targetTeacherClean);
    if (!teacherExists) {
        alert("âš ï¸ æ‰¾ä¸åˆ°è©²ä½è€å¸«ï¼Œè«‹ç¢ºèªå§“åæ˜¯å¦æ­£ç¢ºï¼");
        return;
    }

    // æœå°‹å—å½±éŸ¿çš„èª²ç¨‹
    const affectedClasses = [];

    for (const [classCode, schedule] of Object.entries(classSchedules)) {
      for (const [timeKey, info] of Object.entries(schedule)) {
        const [day, period] = timeKey.split('-');
        
        let tName = typeof info === 'object' ? info.teacher : "";
        let sName = typeof info === 'object' ? info.subject : "";
        
        if (day === targetDay && cleanName(tName) === targetTeacherClean) {
          affectedClasses.push({ classCode, period, subject: sName });
        }
      }
    }

    renderRescheduleTables(affectedClasses, targetTeacherClean, targetDay);
  });
}

function renderRescheduleTables(classList, myNameClean, myLeaveDay) {
  if(!rescheduleResultArea) return;
  rescheduleResultArea.innerHTML = "";

  if (classList.length === 0) {
    rescheduleResultArea.innerHTML = `<div class="alert alert-secondary text-center py-4"><h5>ğŸµ æ˜ŸæœŸ${myLeaveDay} æ‚¨æ²’æœ‰æ’èª²ï¼Œè«‹å®‰å¿ƒä¼‘å‡ã€‚</h5></div>`;
    return;
  }

  classList.sort((a, b) => parseInt(a.period) - parseInt(b.period));

  classList.forEach(item => {
    const classCode = item.classCode;
    const myLeavePeriod = item.period; 
    const myLeaveTimeKey = `${myLeaveDay}-${myLeavePeriod}`;
    const schedule = classSchedules[classCode];

    const card = document.createElement('div');
    card.className = "card mb-4 border-purple shadow-sm";
    
    let headerHtml = `
      <div class="card-header bg-purple text-white d-flex justify-content-between align-items-center">
        <span><span class="badge bg-warning text-dark me-2">ç¬¬ ${myLeavePeriod} ç¯€</span> è«‹å‡èª²ç¨‹ï¼š${classCode}ç­ - ${item.subject}</span>
        <small class="d-none d-md-block opacity-75"><i class="bi bi-arrow-left"></i> èª²è¡¨æ–¹å‘ï¼šé€±ä¸€åœ¨å³ï¼Œé€±äº”åœ¨å·¦</small>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="timetable table-bordered mb-0">
            <thead>
              <tr class="bg-light">
                <th style="width: 18%">é€±äº”</th>
                <th style="width: 18%">é€±å››</th>
                <th style="width: 18%">é€±ä¸‰</th>
                <th style="width: 18%">é€±äºŒ</th>
                <th style="width: 18%" class="table-primary">é€±ä¸€</th>
                <th style="width: 10%">ç¯€æ¬¡</th>
              </tr>
            </thead>
            <tbody>
    `;

    for (let p = 1; p <= 7; p++) {
      headerHtml += `<tr>`;
      
      // å€’åºè¿´åœˆï¼š5(äº”) -> 1(ä¸€)
      for (let d = 5; d >= 1; d--) {
        const currentTimeKey = `${d}-${p}`;
        const cellData = schedule[currentTimeKey];
        
        let cellClass = "";
        let content = `<span class="text-muted">-</span>`;

        // 1. ç›®æ¨™è«‹å‡èª²ç¨‹ (è—è‰²)
        if (d == myLeaveDay && p == myLeavePeriod) {
          cellClass = "cell-target";
          if (cellData) content = `<span class="cell-subject">${cellData.subject}</span><span class="cell-teacher">(æœ¬å ‚è«‹å‡)</span>`;
        } 
        // 2. ç•¶å¤©å…¶ä»–æ™‚æ®µï¼Œè‹¥æœ‰èª²æ‰è®Šç° (ä¸å†æ•´å¤©å¼·åˆ¶ç°)
        else {
          if (cellData) {
            const subj = cellData.subject || "æœªçŸ¥";
            const otherTeacher = cellData.teacher || "ç„¡";
            const otherTeacherDisplay = cleanName(otherTeacher);

            content = `<span class="cell-subject">${subj}</span><span class="cell-teacher">${otherTeacherDisplay}</span>`;

            // 3. åˆ¤æ–·æœ¬äººæ˜¯å¦æœ‰èª² (ç°è‰² - å„ªå…ˆç´šé«˜)
            if (isTeacherBusy(myNameClean, currentTimeKey)) {
               cellClass = "cell-self-busy"; // æˆ‘è‡ªå·±æœ‰èª²ï¼Œä¸èƒ½èª¿ä¾†é€™
               if(d == myLeaveDay) {
                   content += `<span class="text-danger small fw-bold d-block" style="font-size:0.7em">(ç•¶å¤©è«‹å‡)</span>`;
               }
            } else {
              // 4. åˆ¤æ–·å°æ–¹æ˜¯å¦å¯èª¿
              if (otherTeacher !== "ç„¡" && otherTeacherDisplay !== myNameClean) {
                // æª¢æŸ¥å°æ–¹åœ¨ã€Œæˆ‘è«‹å‡çš„æ™‚é–“ã€æ˜¯å¦æœ‰ç©º
                if (isTeacherBusy(otherTeacherDisplay, myLeaveTimeKey)) {
                  cellClass = "cell-swap-no"; // å°æ–¹è©²æ™‚æ®µæœ‰èª² (æ’å ‚)
                } else {
                  // --- v5.0 ä¿®æ”¹ï¼šæª¢æŸ¥æ˜¯å¦ç‚ºæ·ºæ©˜è‰² (ä¸å®œèª¿å‹•) ---
                  if (isDiscouragedCourse(classCode, subj, otherTeacherDisplay)) {
                    cellClass = "cell-swap-discouraged"; // æ·ºæ©˜è‰²
                  } else {
                    cellClass = "cell-swap-ok"; // æ·ºç¶ è‰² (å®Œå…¨å¯èª¿)
                  }
                }
              }
            }
          }
        }

        headerHtml += `<td class="${cellClass}">${content}</td>`;
      }
      
      headerHtml += `<td class="fw-bold bg-light">ç¬¬ ${p} ç¯€</td>`;
      headerHtml += `</tr>`;
    }

    headerHtml += `</tbody></table></div></div>`;
    card.innerHTML = headerHtml;
    rescheduleResultArea.appendChild(card);
  });
}

// 8. å•Ÿå‹•æ™‚è‡ªå‹•è¼‰å…¥è³‡æ–™
document.addEventListener('DOMContentLoaded', () => {
  fetchDataFromCloud();
});
</script>

</body>
</html>

